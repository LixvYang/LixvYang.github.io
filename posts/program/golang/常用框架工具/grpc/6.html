<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>GRPC教程 6 - gRPC元数据处理与加密认证和拦截中间件</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-8a38cc2d.css" as="style"><link rel="stylesheet" href="/assets/style-8a38cc2d.css">
    <link rel="modulepreload" href="/assets/app-927a6ce5.js"><link rel="modulepreload" href="/assets/6.html-277eda6a.js"><link rel="modulepreload" href="/assets/6.html-bb173396.js"><link rel="prefetch" href="/assets/index.html-9cb9b27f.js" as="script"><link rel="prefetch" href="/assets/archives.html-a2c3e3a6.js" as="script"><link rel="prefetch" href="/assets/intro.html-09bd7a82.js" as="script"><link rel="prefetch" href="/assets/Perfect-competition.html-1eea847b.js" as="script"><link rel="prefetch" href="/assets/index.html-f2d38622.js" as="script"><link rel="prefetch" href="/assets/betxin-rules.html-66a96c7d.js" as="script"><link rel="prefetch" href="/assets/Docker-get-start.html-9b396ada.js" as="script"><link rel="prefetch" href="/assets/index.html-1acf6130.js" as="script"><link rel="prefetch" href="/assets/index.html-e095f0cf.js" as="script"><link rel="prefetch" href="/assets/index.html-61ea6e35.js" as="script"><link rel="prefetch" href="/assets/get-start-with-c-tcp-program.html-c3176c76.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-e497774d.js" as="script"><link rel="prefetch" href="/assets/02-how-it-run.html-caed2171.js" as="script"><link rel="prefetch" href="/assets/backtrack.html-cc0321c7.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming.html-a2c9116b.js" as="script"><link rel="prefetch" href="/assets/offer.html-36291455.js" as="script"><link rel="prefetch" href="/assets/mysql-notes.html-98693ea8.js" as="script"><link rel="prefetch" href="/assets/cache-consistency.html-4e4c3673.js" as="script"><link rel="prefetch" href="/assets/datastruct.html-f8fd396a.js" as="script"><link rel="prefetch" href="/assets/redis-note.html-dbd94d87.js" as="script"><link rel="prefetch" href="/assets/global-variable.html-e6d16787.js" as="script"><link rel="prefetch" href="/assets/string.html-d729079c.js" as="script"><link rel="prefetch" href="/assets/2023-09-10-localsent.html-aedeb4f6.js" as="script"><link rel="prefetch" href="/assets/2021-What-I-do.html-79f02199.js" as="script"><link rel="prefetch" href="/assets/I-wrote-a-blockchain-in-160-lines-of-code.html-da3614b0.js" as="script"><link rel="prefetch" href="/assets/I-wrote-a-new-App-that-could-help-me-in-immersed.html-7b85853e.js" as="script"><link rel="prefetch" href="/assets/cosmic-origin.html-d62e8356.js" as="script"><link rel="prefetch" href="/assets/learn-again.html-c97fdf46.js" as="script"><link rel="prefetch" href="/assets/Absolutely-Correct.html-6816f846.js" as="script"><link rel="prefetch" href="/assets/Battle-Internet.html-29eef949.js" as="script"><link rel="prefetch" href="/assets/More-valuable-than-linear-algebra.html-bd4e60b8.js" as="script"><link rel="prefetch" href="/assets/Protect-yourself.html-0714795f.js" as="script"><link rel="prefetch" href="/assets/be-friends-with-time.html-040b37e7.js" as="script"><link rel="prefetch" href="/assets/get-away-wechat.html-a506850a.js" as="script"><link rel="prefetch" href="/assets/patient-with-develop.html-860bec8e.js" as="script"><link rel="prefetch" href="/assets/run.html-3a04e761.js" as="script"><link rel="prefetch" href="/assets/the-future-of-internet.html-56e20762.js" as="script"><link rel="prefetch" href="/assets/two-days.html-ee4a8b1b.js" as="script"><link rel="prefetch" href="/assets/2023-09-07-picking-career.html-a4d2212d.js" as="script"><link rel="prefetch" href="/assets/2023-5-23-why-I-long-write.html-b77fa639.js" as="script"><link rel="prefetch" href="/assets/2023-5-24-danger.html-48b1a93a.js" as="script"><link rel="prefetch" href="/assets/2023-5-25-money-with-life.html-ef8d115b.js" as="script"><link rel="prefetch" href="/assets/2023-5-25-who-are-you_.html-dde215e9.js" as="script"><link rel="prefetch" href="/assets/2023-5-26-what-is-thinking_.html-36bc0255.js" as="script"><link rel="prefetch" href="/assets/2023-5-27-roll-up.html-4ba8cbcb.js" as="script"><link rel="prefetch" href="/assets/2023-5-28-the-realy-true.html-e3af520a.js" as="script"><link rel="prefetch" href="/assets/2023-5-29-in-knowledge-people.html-d53c465f.js" as="script"><link rel="prefetch" href="/assets/2023-5-30-about-thinging-self.html-6e4a4687.js" as="script"><link rel="prefetch" href="/assets/2023-6-14-change-blog.html-94f5416a.js" as="script"><link rel="prefetch" href="/assets/2023-6-16-mini-startup1.html-43181817.js" as="script"><link rel="prefetch" href="/assets/2023-6-2-be-affected.html-756d98a3.js" as="script"><link rel="prefetch" href="/assets/2023-6-23-book-list.html-b91d4a39.js" as="script"><link rel="prefetch" href="/assets/2023-6-23-startup.html-38ef4b32.js" as="script"><link rel="prefetch" href="/assets/2023-6-4-be-a-time-people.html-cd7a9b49.js" as="script"><link rel="prefetch" href="/assets/2023-6-4-self-thinking.html-be47b77b.js" as="script"><link rel="prefetch" href="/assets/2023-6-6-correct-comparison.html-9f84d619.js" as="script"><link rel="prefetch" href="/assets/2023-6-7-best-internet-win.html-ff016ccf.js" as="script"><link rel="prefetch" href="/assets/2023-6-8-praise-short-video.html-aad2627a.js" as="script"><link rel="prefetch" href="/assets/2023-6-9-value-of-gpt.html-68d081de.js" as="script"><link rel="prefetch" href="/assets/top10-sorting.html-7060aed8.js" as="script"><link rel="prefetch" href="/assets/gomock-tuto.html-6cc27dc5.js" as="script"><link rel="prefetch" href="/assets/mockey.html-e84f06c6.js" as="script"><link rel="prefetch" href="/assets/ut.html-9c236227.js" as="script"><link rel="prefetch" href="/assets/air.html-b7853fef.js" as="script"><link rel="prefetch" href="/assets/makefile.html-df7209dc.js" as="script"><link rel="prefetch" href="/assets/snowflake.html-5f7b309c.js" as="script"><link rel="prefetch" href="/assets/web-cookie-jwt.html-b4a577ff.js" as="script"><link rel="prefetch" href="/assets/gin-framework-principle.html-c7dc0253.js" as="script"><link rel="prefetch" href="/assets/gin-use-zerolog.html-93a4dd2e.js" as="script"><link rel="prefetch" href="/assets/1.html-620fd1d6.js" as="script"><link rel="prefetch" href="/assets/2.html-ce06ff04.js" as="script"><link rel="prefetch" href="/assets/3.html-83c685b5.js" as="script"><link rel="prefetch" href="/assets/4.html-a22c66bc.js" as="script"><link rel="prefetch" href="/assets/5.html-52c3a1c7.js" as="script"><link rel="prefetch" href="/assets/zerolog.html-521cbc59.js" as="script"><link rel="prefetch" href="/assets/currency.html-4938f9b1.js" as="script"><link rel="prefetch" href="/assets/go-depth.html-acddb889.js" as="script"><link rel="prefetch" href="/assets/std-bufio.html-eb2dc9f4.js" as="script"><link rel="prefetch" href="/assets/std-context.html-fa04519d.js" as="script"><link rel="prefetch" href="/assets/std-flag.html-e4671b8d.js" as="script"><link rel="prefetch" href="/assets/std-fmt.html-a6f94e71.js" as="script"><link rel="prefetch" href="/assets/std-log.html-ee63cfa6.js" as="script"><link rel="prefetch" href="/assets/std-reflect.html-5d3c09fd.js" as="script"><link rel="prefetch" href="/assets/std-strconv.html-575c2685.js" as="script"><link rel="prefetch" href="/assets/std-time.html-f3af3879.js" as="script"><link rel="prefetch" href="/assets/qmgo.html-68e9f49b.js" as="script"><link rel="prefetch" href="/assets/validator.html-55fa0c4b.js" as="script"><link rel="prefetch" href="/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/assets/index.html-3b59dd05.js" as="script"><link rel="prefetch" href="/assets/archives.html-1bb6f948.js" as="script"><link rel="prefetch" href="/assets/intro.html-2184a31a.js" as="script"><link rel="prefetch" href="/assets/Perfect-competition.html-30e93582.js" as="script"><link rel="prefetch" href="/assets/index.html-7aaa9963.js" as="script"><link rel="prefetch" href="/assets/betxin-rules.html-84ef16f4.js" as="script"><link rel="prefetch" href="/assets/Docker-get-start.html-b507cea3.js" as="script"><link rel="prefetch" href="/assets/index.html-9062f7c0.js" as="script"><link rel="prefetch" href="/assets/index.html-201e47fe.js" as="script"><link rel="prefetch" href="/assets/index.html-560ff124.js" as="script"><link rel="prefetch" href="/assets/get-start-with-c-tcp-program.html-1a38a5b1.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-1beaddbc.js" as="script"><link rel="prefetch" href="/assets/02-how-it-run.html-090c59d1.js" as="script"><link rel="prefetch" href="/assets/backtrack.html-a2606d4e.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming.html-72358848.js" as="script"><link rel="prefetch" href="/assets/offer.html-997f5d0c.js" as="script"><link rel="prefetch" href="/assets/mysql-notes.html-c0cec67a.js" as="script"><link rel="prefetch" href="/assets/cache-consistency.html-4efa0df4.js" as="script"><link rel="prefetch" href="/assets/datastruct.html-3c60fecc.js" as="script"><link rel="prefetch" href="/assets/redis-note.html-757e3c02.js" as="script"><link rel="prefetch" href="/assets/global-variable.html-f66c58c5.js" as="script"><link rel="prefetch" href="/assets/string.html-ccf744db.js" as="script"><link rel="prefetch" href="/assets/2023-09-10-localsent.html-948a664b.js" as="script"><link rel="prefetch" href="/assets/2021-What-I-do.html-8c1a0744.js" as="script"><link rel="prefetch" href="/assets/I-wrote-a-blockchain-in-160-lines-of-code.html-9a14fe04.js" as="script"><link rel="prefetch" href="/assets/I-wrote-a-new-App-that-could-help-me-in-immersed.html-2249c347.js" as="script"><link rel="prefetch" href="/assets/cosmic-origin.html-160cd230.js" as="script"><link rel="prefetch" href="/assets/learn-again.html-5e0c1266.js" as="script"><link rel="prefetch" href="/assets/Absolutely-Correct.html-a5523894.js" as="script"><link rel="prefetch" href="/assets/Battle-Internet.html-f2603b08.js" as="script"><link rel="prefetch" href="/assets/More-valuable-than-linear-algebra.html-1f0744da.js" as="script"><link rel="prefetch" href="/assets/Protect-yourself.html-976f44f7.js" as="script"><link rel="prefetch" href="/assets/be-friends-with-time.html-4b364f1c.js" as="script"><link rel="prefetch" href="/assets/get-away-wechat.html-e322d242.js" as="script"><link rel="prefetch" href="/assets/patient-with-develop.html-bee60750.js" as="script"><link rel="prefetch" href="/assets/run.html-a778d1ef.js" as="script"><link rel="prefetch" href="/assets/the-future-of-internet.html-5302e711.js" as="script"><link rel="prefetch" href="/assets/two-days.html-3e93df67.js" as="script"><link rel="prefetch" href="/assets/2023-09-07-picking-career.html-e2763e46.js" as="script"><link rel="prefetch" href="/assets/2023-5-23-why-I-long-write.html-1d9f1c14.js" as="script"><link rel="prefetch" href="/assets/2023-5-24-danger.html-b4c33e04.js" as="script"><link rel="prefetch" href="/assets/2023-5-25-money-with-life.html-46443e1a.js" as="script"><link rel="prefetch" href="/assets/2023-5-25-who-are-you_.html-2f353692.js" as="script"><link rel="prefetch" href="/assets/2023-5-26-what-is-thinking_.html-540a0487.js" as="script"><link rel="prefetch" href="/assets/2023-5-27-roll-up.html-ca0b1eb7.js" as="script"><link rel="prefetch" href="/assets/2023-5-28-the-realy-true.html-99a60bb4.js" as="script"><link rel="prefetch" href="/assets/2023-5-29-in-knowledge-people.html-9f293547.js" as="script"><link rel="prefetch" href="/assets/2023-5-30-about-thinging-self.html-8ff1f41c.js" as="script"><link rel="prefetch" href="/assets/2023-6-14-change-blog.html-cdbbeb5a.js" as="script"><link rel="prefetch" href="/assets/2023-6-16-mini-startup1.html-141ddd6a.js" as="script"><link rel="prefetch" href="/assets/2023-6-2-be-affected.html-c6eb0ebf.js" as="script"><link rel="prefetch" href="/assets/2023-6-23-book-list.html-8a1498f0.js" as="script"><link rel="prefetch" href="/assets/2023-6-23-startup.html-13c31696.js" as="script"><link rel="prefetch" href="/assets/2023-6-4-be-a-time-people.html-50360944.js" as="script"><link rel="prefetch" href="/assets/2023-6-4-self-thinking.html-eea1deda.js" as="script"><link rel="prefetch" href="/assets/2023-6-6-correct-comparison.html-5ae97d6b.js" as="script"><link rel="prefetch" href="/assets/2023-6-7-best-internet-win.html-f438a0ac.js" as="script"><link rel="prefetch" href="/assets/2023-6-8-praise-short-video.html-2257b1f8.js" as="script"><link rel="prefetch" href="/assets/2023-6-9-value-of-gpt.html-5bca605b.js" as="script"><link rel="prefetch" href="/assets/top10-sorting.html-c9c9b995.js" as="script"><link rel="prefetch" href="/assets/gomock-tuto.html-64eece47.js" as="script"><link rel="prefetch" href="/assets/mockey.html-67ae4a84.js" as="script"><link rel="prefetch" href="/assets/ut.html-9897607d.js" as="script"><link rel="prefetch" href="/assets/air.html-af1b0fa5.js" as="script"><link rel="prefetch" href="/assets/makefile.html-7f3742ec.js" as="script"><link rel="prefetch" href="/assets/snowflake.html-185a0f62.js" as="script"><link rel="prefetch" href="/assets/web-cookie-jwt.html-f6dda3a4.js" as="script"><link rel="prefetch" href="/assets/gin-framework-principle.html-03db1c65.js" as="script"><link rel="prefetch" href="/assets/gin-use-zerolog.html-0f30e282.js" as="script"><link rel="prefetch" href="/assets/1.html-dd36e2f5.js" as="script"><link rel="prefetch" href="/assets/2.html-86d2ced9.js" as="script"><link rel="prefetch" href="/assets/3.html-5c922fa3.js" as="script"><link rel="prefetch" href="/assets/4.html-0066bdd2.js" as="script"><link rel="prefetch" href="/assets/5.html-31b5717e.js" as="script"><link rel="prefetch" href="/assets/zerolog.html-16bc5288.js" as="script"><link rel="prefetch" href="/assets/currency.html-32942ee9.js" as="script"><link rel="prefetch" href="/assets/go-depth.html-10c7aede.js" as="script"><link rel="prefetch" href="/assets/std-bufio.html-2635ae14.js" as="script"><link rel="prefetch" href="/assets/std-context.html-874e792d.js" as="script"><link rel="prefetch" href="/assets/std-flag.html-8617314f.js" as="script"><link rel="prefetch" href="/assets/std-fmt.html-6f152bb9.js" as="script"><link rel="prefetch" href="/assets/std-log.html-c10dcec5.js" as="script"><link rel="prefetch" href="/assets/std-reflect.html-d33d3416.js" as="script"><link rel="prefetch" href="/assets/std-strconv.html-f179428e.js" as="script"><link rel="prefetch" href="/assets/std-time.html-dd771a1a.js" as="script"><link rel="prefetch" href="/assets/qmgo.html-8b643589.js" as="script"><link rel="prefetch" href="/assets/validator.html-784017e9.js" as="script"><link rel="prefetch" href="/assets/404.html-d7138cfa.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">GRPC教程 6 - gRPC元数据处理与加密认证和拦截中间件 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#元数据处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="元数据处理"><!--[--><!--]--> 元数据处理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#发送接收元数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="发送接收元数据"><!--[--><!--]--> 发送接收元数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#设置header和trailer" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置header和trailer"><!--[--><!--]--> 设置header和trailer <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#拦截中间件" class="router-link-active router-link-exact-active sidebar-item" aria-label="拦截中间件"><!--[--><!--]--> 拦截中间件 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#注册拦截器" class="router-link-active router-link-exact-active sidebar-item" aria-label="注册拦截器"><!--[--><!--]--> 注册拦截器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#加密处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="加密处理"><!--[--><!--]--> 加密处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#grpc的加密处理中间件" class="router-link-active router-link-exact-active sidebar-item" aria-label="gRPC的加密处理中间件"><!--[--><!--]--> gRPC的加密处理中间件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#grpc拦截器和gin的拦截器对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="gRPC拦截器和gin的拦截器对比"><!--[--><!--]--> gRPC拦截器和gin的拦截器对比 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/posts/program/golang/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7/grpc/6.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><p>本篇教程我们来讲解gRPC的元数据处理和拦截的中间件</p><!-- more --><h1 id="grpc教程-6-grpc元数据处理与加密认证和拦截中间件" tabindex="-1"><a class="header-anchor" href="#grpc教程-6-grpc元数据处理与加密认证和拦截中间件" aria-hidden="true">#</a> GRPC教程 6 - gRPC元数据处理与加密认证和拦截中间件</h1><h2 id="元数据处理" tabindex="-1"><a class="header-anchor" href="#元数据处理" aria-hidden="true">#</a> 元数据处理</h2><p>首先，先来讲一讲，元数据(metadata)，元数据是指在处理RPC请求中，不放在正文的数据，比如身份信息token(不属于业务信息)可以放在元数据中，通常以<code>map[string][]string</code>的形式存放，key是string，value是[]string类型。gRPC里规定可以存放二进制数据(key以-bin结尾)，key不能以grpc开头(因为有grp以grpc开头的数据)。元数据对于gRPC本身是不可见的，我们通常在上下文代码中存放元数据，在Go语言中我们通过https://pkg.go.dev/google.golang.org/grpc/metadata 仓库去访问元数据。</p><p>元数据的定义如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> MD <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

<span class="token comment">// 可以看到它的类型是map[string][]string。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过metadata.New()或metadata.Pairs去创建一个MD, 或者可以先创建一个MD，然后通过metadata.Join()去往这个MD里面添加元数据。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// md := metadata.New(map[string]string{&quot;key1&quot;: &quot;val1&quot;})</span>
md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
	<span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string value&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;key-bin&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 二进制数据在发送前会进行(base64) 编码</span>
	<span class="token comment">// 收到后会进行解码</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以发现MD有一些常见的使用方法</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> MD <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">,</span> vals <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span>MD
<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>MD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">,</span> vals <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过这些方法去对元数据进行一些操作。</p><h3 id="发送接收元数据" tabindex="-1"><a class="header-anchor" href="#发送接收元数据" aria-hidden="true">#</a> 发送接收元数据</h3><p>我们先说说在metadata包中发送元数据的方法,</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//此方法可以将元数据添加到已有的ctx中。好处是不会覆盖之前ctx的metadata</span>
metadata<span class="token punctuation">.</span><span class="token function">AppendToOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Lixin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AGE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span> 

<span class="token comment">// 这个方法metadata.NewOutgoingContext这个方法会覆盖之前crtx中的metadata。</span>
b <span class="token operator">:=</span> <span class="token string">&quot;This is bin message&quot;</span>
<span class="token comment">// md := metadata.New(map[string]string{&quot;key1&quot;: &quot;val1&quot;})</span>
md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
	<span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string value&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;key-bin&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 二进制数据在发送前会进行(base64) 编码</span>
	<span class="token comment">// 收到后会进行解码</span>
<span class="token punctuation">)</span>
ctx <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> md<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来说一说接收metadata的方法</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="设置header和trailer" tabindex="-1"><a class="header-anchor" href="#设置header和trailer" aria-hidden="true">#</a> 设置header和trailer</h3><p>Header和trailer可以简单的理解为头和尾。类似于我们调用HTTP方法的头和尾一样属于元数据的一部分。</p><p>在gRPC的上下文中，服务端方可以给客户端方设置header和trailer，客户端可以接受header和trailer。</p><p>首先介绍服务器端如何发送header和trailer</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>   <span class="token comment">// 创建和发送 header</span>
    header <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;header-name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    grpc<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
    <span class="token comment">// 创建和发送 trailer</span>
    trailer <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">&quot;trailer-age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span>
    grpc<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是客户端接收请求的header和trailer</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> header<span class="token punctuation">,</span> trailer metadata<span class="token punctuation">.</span>MD 
r<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">,</span>
   <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloReq<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Lixin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    grpc<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 将会接收header</span>
    grpc<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trailer<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 将会接收trailer</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面我们做个示例去使用metadata。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// client.go</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:7890&quot;</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	c <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewGreeteringClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	metadata<span class="token punctuation">.</span><span class="token function">AppendToOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Lixin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AGE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span>

	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> <span class="token string">&quot;This is bin message&quot;</span>
	<span class="token comment">// md := metadata.New(map[string]string{&quot;key1&quot;: &quot;val1&quot;})</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
		<span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string value&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;key-bin&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 二进制数据在发送前会进行(base64) 编码</span>
		<span class="token comment">// 收到后会进行解码</span>
	<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	<span class="token keyword">var</span> header<span class="token punctuation">,</span>trailer metadata<span class="token punctuation">.</span>MD
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloReq<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;nn&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trailer<span class="token punctuation">)</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>trailer<span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">GetMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// server.go</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;No metadata!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	md <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	md <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
		<span class="token string">&quot;AGE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	err <span class="token operator">=</span> grpc<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResp<span class="token punctuation">{</span>
		Msg<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello %s!\n&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="拦截中间件" tabindex="-1"><a class="header-anchor" href="#拦截中间件" aria-hidden="true">#</a> 拦截中间件</h2><p>GRPC可以在RPC的Client/Server的基础上提供了拦截器的中间件。拦截器可以在每次调用GRPC调用的时候记录一些信息或者验证用户token(比如响应时间数据等)。</p><h3 id="注册拦截器" tabindex="-1"><a class="header-anchor" href="#注册拦截器" aria-hidden="true">#</a> 注册拦截器</h3><p>首先我们之前的文章/视频讲过，GRPC请求分为直接请求和流式请求，当我们使用直接请求的时候对应的就是一元拦截器，流式请求就是流拦截器。我们这里的示例是一元拦截器，就是直接请求GRPC服务拦截器的使用，在客户端和服务器端都可以自定义拦截器。</p><p>怎么去使用拦截器呢？</p><p>在server端，我们只需要在注册GRPC服务的时候加入对应拦截器(Interceptor)。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>unaryInterceptor<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>并且我们需要实现unaryInterceptor 函数类型是</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UnaryServerInterceptor <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>UnaryServerInfo<span class="token punctuation">,</span> handler UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span>resp <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在client端呢？我们需要在Dial GRPC服务IP端口的时候，加入<code>grpc.WithUnaryInterceptor(unaryInterceptor)</code>, 就可以实现客户端的拦截器。</p><p>那我们就来实践一下吧, 我们想先在客户端加一个拦截器，比如我们想让每次传输的字节数不超过3，那么就有对应的方法来实现</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// unaryInterceptor 客户端一元拦截器</span>
<span class="token keyword">func</span> <span class="token function">unaryInterceptor</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> invoker grpc<span class="token punctuation">.</span>UnaryInvoker<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">MaxCallSendMsgSize</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">invoker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;reply: &quot;</span><span class="token punctuation">,</span> reply<span class="token punctuation">)</span>
	end <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;RPC: %s, start time: %s, end time: %s, err: %v\n&quot;</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Basic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务器端这里什么都不需要做，因为我们只在客户端加一个拦截器，如果传入的字节数超过3，那么会直接返回错误的。</p><h3 id="加密处理" tabindex="-1"><a class="header-anchor" href="#加密处理" aria-hidden="true">#</a> 加密处理</h3><p>参考https://www.liwenzhou.com/posts/Go/gRPC/#autoid-0-9-1</p><h3 id="grpc的加密处理中间件" tabindex="-1"><a class="header-anchor" href="#grpc的加密处理中间件" aria-hidden="true">#</a> gRPC的加密处理中间件</h3><p>那如果我们想让中间件有加密处理这一层呢？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// server.go</span>

creds<span class="token punctuation">,</span> err <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewServerTLSFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;certs/server.crt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;certs/server.key&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>unaryInterceptor<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// valid 校验认证信息.</span>
<span class="token keyword">func</span> <span class="token function">valid</span><span class="token punctuation">(</span>authorization <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	token <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>authorization<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 执行token认证的逻辑</span>
	<span class="token comment">// 这里是为了演示方便简单判断token是否与&quot;some-secret-token&quot;相等</span>
	<span class="token keyword">return</span> token <span class="token operator">==</span> <span class="token string">&quot;some-secret-token&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// unaryInterceptor 服务端一元拦截器</span>
<span class="token keyword">func</span> <span class="token function">unaryInterceptor</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// authentication (token verification)</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;missing metadata&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">valid</span><span class="token punctuation">(</span>md<span class="token punctuation">[</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">&quot;invalid token&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	m<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;RPC failed with error %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// client.go

certs, err := credentials.NewClientTLSFromFile(&quot;./certs/server.crt&quot;, &quot;&quot;)
	if err != nil {
		log.Fatal(err)
	}

	conn, err := grpc.Dial(&quot;127.0.0.1:7890&quot;, grpc.WithTransportCredentials(certs), grpc.WithUnaryInterceptor(unaryInterceptor))

// unaryInterceptor 客户端一元拦截器
func unaryInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {
	var credsConfigured bool
	for _, o := range opts {
		_, ok := o.(grpc.PerRPCCredsCallOption)
		if ok {
			credsConfigured = true
			break
		}
	}
	if !credsConfigured {
		opts = append(opts, grpc.PerRPCCredentials(oauth.NewOauthAccess(&amp;oauth2.Token{
			AccessToken: &quot;some-secret-token&quot;,
		})))
	}

	opts = append(opts, grpc.MaxCallSendMsgSize(5))

	start := time.Now()
	err := invoker(ctx, method, req, reply, cc, opts...)
	fmt.Println(&quot;reply: &quot;, reply)
	end := time.Now()
	fmt.Printf(&quot;RPC: %s, start time: %s, end time: %s, err: %v\n&quot;, method, start.Format(&quot;Basic&quot;), end.Format(time.RFC3339), err)
	return err
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样我们就可以通过中间件来判断有没有加密处理了，如果没有加密处理，我们的服务端是直接拒接请求的。</p><h3 id="grpc拦截器和gin的拦截器对比" tabindex="-1"><a class="header-anchor" href="#grpc拦截器和gin的拦截器对比" aria-hidden="true">#</a> gRPC拦截器和gin的拦截器对比</h3><p>Gin框架的拦截器呢？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>

	<span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
				<span class="token string">&quot;exit&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Sorry.&quot;</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			ctx<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		count<span class="token operator">++</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;This is a intercepter.&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
			<span class="token string">&quot;Hello&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Lixin&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;:7899&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>元数据处理 拦截器 GRPC的加密处理 GIN和GRPC 拦截器的对比</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: lixin@lixins-MacBook-Pro.local">lixin</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-927a6ce5.js" defer></script>
  </body>
</html>
